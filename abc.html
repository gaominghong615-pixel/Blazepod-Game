<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Webduino BlazePod (玩家專注版)</title>

<!-- Webduino & Bootstrap & Icons -->
<script src="https://blocklypro.webduino.io/node_modules/jquery/dist/jquery.min.js"></script>
<script src="https://blocklypro.webduino.io/dist/lib/webduino-all-0.4.20.min.js"></script>
<script src="https://blocklypro.webduino.io/dist/webduino-blockly.min.js"></script>
<script src="https://blocklypro.webduino.io/dist/lib/firebase.min.js"></script>
<script src="https://blocklypro.webduino.io/dist/lib/runtime.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
  /* 全域暗色風格 */
  body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', Roboto, sans-serif; user-select: none; }
  
  /* 視圖切換 */
  .view-section { display: none; animation: fadeIn 0.3s; }
  .view-section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* 輸入框樣式 */
  .form-control-dark, .form-select-dark {
    background-color: #2c2c2c; color: #fff; border: 1px solid #444;
  }
  .form-control-dark:focus, .form-select-dark:focus {
    background-color: #333; color: #fff; border-color: #00e676; box-shadow: 0 0 5px rgba(0,230,118,0.5);
  }

  /* --- 玩家模式 (簡潔) --- */
  .player-pod-grid {
    display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 30px 0;
  }
  .big-pod {
    width: 80px; height: 80px; border-radius: 50%;
    background: #222; border: 4px solid #444;
    box-shadow: inset 0 0 15px #000;
    transition: all 0.2s; position: relative;
  }
  /* 燈亮時的效果 */
  .big-pod.lit { transform: scale(1.1); }
  
  .score-board {
    background: #1e1e1e; border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid #333;
  }
  .score-val { font-size: 3rem; font-weight: 900; color: #ffeb3b; line-height: 1; }
  .score-label { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

  /* --- 設定模式 (詳細) --- */
  .settings-card { background: #1e1e1e; border: 1px solid #333; margin-bottom: 15px; }
  .settings-header { background: #252525; padding: 10px 15px; border-bottom: 1px solid #333; color: #00e676; font-weight: bold; }
  
  .signal-dot {
    width: 10px; height: 10px; background: #333; border-radius: 50%; 
    display: inline-block; margin-left: 5px; border: 1px solid #555;
  }
  .signal-dot.active { background: #ffeb3b; box-shadow: 0 0 8px #ffeb3b; }
  
  .console-box { 
    background: #000; height: 150px; overflow-y: auto; 
    font-family: monospace; font-size: 11px; padding: 10px; border: 1px solid #333; color: #00e676; 
  }
</style>
</head>
<body>

<!-- 頂部導航 -->
<nav class="navbar navbar-dark bg-dark border-bottom border-secondary mb-3">
  <div class="container">
    <span class="navbar-brand mb-0 h1"><i class="bi bi-lightning-charge-fill text-success"></i> BlazePod 訓練</span>
    <button class="btn btn-outline-secondary btn-sm" onclick="toggleView()">
      <i class="bi bi-gear-fill" id="settings-icon"></i> <span id="view-btn-text">設定</span>
    </button>
  </div>
</nav>

<div class="container">

  <!-- ================= 1. 玩家模式 (簡潔介面) ================= -->
  <div id="view-player" class="view-section active">
    
    <!-- 分數與時間 -->
    <div class="score-board text-center row">
      <div class="col-4 border-end border-secondary">
        <div class="score-label">得分 (Score)</div>
        <div class="score-val" id="disp-score">0</div>
      </div>
      <div class="col-4 border-end border-secondary">
        <div class="score-label">反應時間 (Sec)</div>
        <div class="score-val text-white" style="font-size:2.5rem" id="disp-time">-</div>
      </div>
      <div class="col-4">
        <div class="score-label">目標色 (Target)</div>
        <div id="target-badge" class="mt-2 badge rounded-pill bg-dark border border-secondary" 
             style="font-size:1.2rem; min-width:80px;">未開始</div>
      </div>
    </div>

    <!-- 裝置燈號顯示區 (僅顯示燈色，無文字) -->
    <div class="player-pod-grid" id="player-pod-container">
      <!-- JS 動態生成圓圈 -->
    </div>

    <!-- 遊戲控制 -->
    <div class="card p-3" style="background:#1e1e1e; border:1px solid #333;">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label text-muted small">玩家名稱</label>
          <input type="text" id="p-name" class="form-control form-control-dark fw-bold" placeholder="Player 1" onchange="saveMainSettings()">
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small">總回合數</label>
          <input type="number" id="p-rounds" class="form-control form-control-dark text-center fw-bold" value="10" onchange="saveMainSettings()">
        </div>
        <div class="col-md-5">
           <label class="form-label text-info small fw-bold">選擇目標顏色</label>
           <select id="p-color" class="form-select form-select-dark text-center fw-bold" style="border: 1px solid #00e676;">
             <!-- JS 填入 -->
           </select>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-8">
          <button onclick="gameStart()" id="btn-start-game" class="btn btn-success w-100 py-2 fw-bold fs-5" disabled>
            <i class="bi bi-play-fill"></i> 開始遊戲
          </button>
        </div>
        <div class="col-4">
          <button onclick="stopGame()" class="btn btn-outline-danger w-100 py-2 fw-bold">
            <i class="bi bi-stop-fill"></i> 停止
          </button>
        </div>
      </div>
      <div class="text-center mt-2">
         <small id="conn-status" class="text-secondary">裝置未連線，請至設定頁面連線</small>
      </div>
    </div>
  </div>


  <!-- ================= 2. 設定模式 (裝置與參數) ================= -->
  <div id="view-settings" class="view-section">
    
    <div class="alert alert-secondary py-2" style="font-size:0.9rem">
      <i class="bi bi-info-circle"></i> 請在此處連線裝置並調整靈敏度 (TH)。<br>
      調校技巧：調整 TH 直到小黃點熄滅，手遮擋時小黃點亮起。
    </div>

    <!-- 裝置列表 -->
    <div class="settings-card">
      <div class="settings-header d-flex justify-content-between">
        <span>裝置管理 (Smart)</span>
        <button class="btn btn-sm btn-outline-light py-0" onclick="saveAllSettings()">儲存所有設定</button>
      </div>
      <div class="p-2" id="settings-list">
        <!-- JS 生成詳細設定列表 -->
      </div>
    </div>

    <!-- 進階參數 -->
    <div class="settings-card">
      <div class="settings-header">雲端設定</div>
      <div class="p-3">
        <label class="form-label text-secondary small">Google Apps Script URL (資料上傳用)</label>
        <input type="text" id="gas-url" class="form-control form-control-dark" placeholder="https://script.google.com/..." onchange="saveMainSettings()">
      </div>
    </div>

    <!-- 除錯視窗 -->
    <div class="settings-card">
      <div class="settings-header py-1" style="font-size:0.8rem">系統訊息 (Console)</div>
      <div class="console-box" id="console"></div>
    </div>

  </div>

</div>

<script>
// ================= 全域變數 =================
const MAX_PODS = 6;
const COLORS = [
  { name: '紅色', code: 'red',     r:1, g:0, b:0, hex:'#ff3333' },
  { name: '綠色', code: 'green',   r:0, g:1, b:0, hex:'#33ff33' },
  { name: '藍色', code: 'blue',    r:0, g:0, b:1, hex:'#3388ff' },
  { name: '黃色', code: 'yellow',  r:1, g:1, b:0, hex:'#ffff33' },
  { name: '紫色', code: 'purple',  r:1, g:0, b:1, hex:'#ff33ff' },
  { name: '青色', code: 'cyan',    r:0, g:1, b:1, hex:'#33ffff' },
  { name: '白色', code: 'white',   r:1, g:1, b:1, hex:'#ffffff' }
];

let pods = [];
let isSettingsMode = false;
let gameState = {
  isPlaying: false,
  totalRounds: 10,
  currentRound: 0,
  score: 0,
  targetPodIndex: -1,
  targetColorObj: null,
  startTime: 0,
  bestTime: 9999,
  isLocked: false
};

// ================= 初始化 =================
window.onload = function() {
  initUI();
  loadAllSettings();
  log("系統就緒，請先進入設定頁面連線裝置");
};

function initUI() {
  // 1. 生成顏色選項
  const sel = document.getElementById('p-color');
  COLORS.forEach(c => {
    let opt = document.createElement('option');
    opt.value = c.code;
    opt.innerText = c.name;
    if(c.code === 'red') opt.selected = true;
    sel.appendChild(opt);
  });

  // 2. 生成 Pods 介面 (玩家畫面 + 設定畫面)
  const playerContainer = document.getElementById('player-pod-container');
  const settingsContainer = document.getElementById('settings-list');

  for(let i=0; i<MAX_PODS; i++) {
    pods.push({ id: i, board: null, deviceId: '', connected: false, active: true, lastVal: 1.0 });

    // (A) 玩家畫面 - 大圓燈
    let bigPod = document.createElement('div');
    bigPod.className = 'big-pod';
    bigPod.id = `big-pod-${i}`;
    bigPod.title = `POD ${i+1}`;
    // 預設隱藏，有連線才顯示 (或選擇全部顯示但灰色) -> 這裡選擇全部顯示但灰色
    playerContainer.appendChild(bigPod);

    // (B) 設定畫面 - 詳細控制列
    settingsContainer.innerHTML += `
      <div class="row align-items-center border-bottom border-secondary py-2 mx-0">
        <!-- 啟用開關 -->
        <div class="col-1 text-center">
          <input type="checkbox" id="check-${i}" checked onchange="togglePodActive(${i})">
        </div>
        
        <!-- ID 輸入 -->
        <div class="col-4">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-dark text-secondary">ID</span>
            <input type="text" id="devid-${i}" class="form-control form-control-dark" placeholder="Smart ID" onchange="savePodSettings(${i})">
          </div>
        </div>

        <!-- TH 設定與數值顯示 -->
        <div class="col-5">
           <div class="d-flex align-items-center gap-2">
             <div class="input-group input-group-sm" style="width:120px">
               <span class="input-group-text bg-dark text-secondary">TH</span>
               <input type="number" id="th-${i}" class="form-control form-control-dark text-center" 
                      step="0.001" min="0" max="1" value="0.150" onchange="savePodSettings(${i})">
             </div>
             <!-- 狀態指示 -->
             <div class="small text-muted" style="font-family:monospace">
               Val: <span id="val-${i}" class="text-white">-</span>
             </div>
             <div id="sig-${i}" class="signal-dot" title="觸發指示燈"></div>
           </div>
        </div>

        <!-- 連線按鈕 -->
        <div class="col-2 text-end">
          <button id="btn-conn-${i}" class="btn btn-primary btn-sm w-100" onclick="connectPod(${i})">連線</button>
        </div>
      </div>
    `;
  }
}

// 切換視圖 (玩家 <-> 設定)
function toggleView() {
  isSettingsMode = !isSettingsMode;
  const playerView = document.getElementById('view-player');
  const settingsView = document.getElementById('view-settings');
  const btnText = document.getElementById('view-btn-text');
  const icon = document.getElementById('settings-icon');

  if(isSettingsMode) {
    playerView.classList.remove('active');
    settingsView.classList.add('active');
    btnText.innerText = "返回遊戲";
    icon.classList.replace('bi-gear-fill', 'bi-controller');
  } else {
    settingsView.classList.remove('active');
    playerView.classList.add('active');
    btnText.innerText = "設定";
    icon.classList.replace('bi-controller', 'bi-gear-fill');
  }
}

// ================= 資料記憶 (LocalStorage) =================
function saveMainSettings() {
  localStorage.setItem('bp_pname', document.getElementById('p-name').value);
  localStorage.setItem('bp_rounds', document.getElementById('p-rounds').value);
  localStorage.setItem('bp_gas', document.getElementById('gas-url').value);
}

function savePodSettings(idx) {
  const id = document.getElementById(`devid-${idx}`).value;
  const th = document.getElementById(`th-${idx}`).value;
  localStorage.setItem(`bp_id_${idx}`, id);
  localStorage.setItem(`bp_th_${idx}`, th);
}

function saveAllSettings() {
  saveMainSettings();
  for(let i=0; i<MAX_PODS; i++) savePodSettings(i);
  alert("設定已儲存！");
}

function loadAllSettings() {
  if(localStorage.getItem('bp_pname')) document.getElementById('p-name').value = localStorage.getItem('bp_pname');
  if(localStorage.getItem('bp_rounds')) document.getElementById('p-rounds').value = localStorage.getItem('bp_rounds');
  if(localStorage.getItem('bp_gas')) document.getElementById('gas-url').value = localStorage.getItem('bp_gas');

  for(let i=0; i<MAX_PODS; i++) {
    const savedId = localStorage.getItem(`bp_id_${i}`);
    const savedTh = localStorage.getItem(`bp_th_${i}`);
    if(savedId) document.getElementById(`devid-${i}`).value = savedId;
    if(savedTh) document.getElementById(`th-${i}`).value = savedTh;
  }
}

// ================= 硬體邏輯 =================
function connectPod(index) {
  const devId = document.getElementById(`devid-${index}`).value.trim();
  if(!devId) return alert("請輸入 Device ID");
  savePodSettings(index);

  const btn = document.getElementById(`btn-conn-${index}`);
  btn.disabled = true; btn.innerText = "...";

  boardReady({ board: 'Smart', device: devId, transport: 'mqtt' }, function(board) {
    board.samplingInterval = 20;
    pods[index].board = board;
    pods[index].connected = true;
    pods[index].deviceId = devId;

    try {
        // 設定 RGB 腳位 (包含內建與擴充)
        board.setPinMode(15, 1); board.setPinMode(12, 1); board.setPinMode(13, 1);
        board.setPinMode(6, 1); board.setPinMode(7, 1); board.setPinMode(8, 1);
    } catch(e){}
    
    // 預設關燈
    setPodVisual(index, 0, 0, 0);

    // 啟動光敏
    pods[index].photocell = getPhotocell(board, 0);
    pods[index].photocell.measure(function(val) {
        handleSensorData(index, val);
    });

    btn.innerText = "OK";
    btn.classList.replace("btn-primary", "btn-success");
    checkConnections();
    log(`Device ${index+1} (${devId}) 已連線`);
  });
}

function checkConnections() {
  const connectedCount = pods.filter(p => p.connected).length;
  const statusTxt = document.getElementById('conn-status');
  const startBtn = document.getElementById('btn-start-game');

  if (connectedCount > 0) {
    statusTxt.innerHTML = `<span class="text-success">● 已連線 ${connectedCount} 台裝置</span>`;
    startBtn.disabled = false;
  }
}

function togglePodActive(index) {
  pods[index].active = document.getElementById(`check-${index}`).checked;
  // 更新大圓燈的透明度表示啟用狀態
  document.getElementById(`big-pod-${index}`).style.opacity = pods[index].active ? "1" : "0.2";
}

// 統一控制燈光與視覺 (同時更新 玩家畫面 與 設定畫面)
function setPodVisual(index, r, g, b) {
  const p = pods[index];
  
  // 1. 硬體寫入
  if(p.connected && p.board) {
    try {
       const int = { r: p.board.getDigitalPin(15), g: p.board.getDigitalPin(12), b: p.board.getDigitalPin(13) };
       const ext = { r: p.board.getDigitalPin(6), g: p.board.getDigitalPin(7), b: p.board.getDigitalPin(8) };
       if(int.r) int.r.write(r); if(int.g) int.g.write(g); if(int.b) int.b.write(b);
       if(ext.r) ext.r.write(r); if(ext.g) ext.g.write(g); if(ext.b) ext.b.write(b);
    } catch(e){}
  }

  // 2. 網頁視覺更新
  const hasColor = (r || g || b);
  const colorHex = hasColor ? `rgb(${r*255},${g*255},${b*255})` : '#222';
  const shadow = hasColor ? `0 0 25px ${colorHex}` : 'inset 0 0 15px #000';
  
  // 更新玩家模式的大圓燈
  const bigPod = document.getElementById(`big-pod-${index}`);
  bigPod.style.backgroundColor = colorHex;
  bigPod.style.boxShadow = shadow;
  bigPod.style.borderColor = hasColor ? '#fff' : '#444';
  if(hasColor) bigPod.classList.add('lit'); else bigPod.classList.remove('lit');
}

// ================= 感測邏輯 =================
function handleSensorData(index, val) {
  const p = pods[index];
  const currentVal = Number(val);
  const th = parseFloat(document.getElementById(`th-${index}`).value) || 0.150;

  // 更新設定頁面的數值
  const valEl = document.getElementById(`val-${index}`);
  if(valEl) valEl.innerText = currentVal.toFixed(3);

  if (p.active && p.connected) {
      // 觸發指示燈 (設定頁面的小黃點)
      const dot = document.getElementById(`sig-${index}`);
      if (currentVal < th) dot.classList.add('active'); 
      else dot.classList.remove('active');

      // 遊戲判定 (Falling Edge)
      if (gameState.isPlaying && !gameState.isLocked) {
         if (p.lastVal >= th && currentVal < th) {
             if (index === gameState.targetPodIndex) {
                 handleHit(true, index);
             } else {
                 // 拍錯不用特別懲罰，也可以閃爍紅燈
                 log(`Pod ${index+1} 誤觸`);
             }
         }
      }
  }
  p.lastVal = currentVal;
}

// ================= 遊戲流程 =================
function gameStart() {
  if(gameState.isPlaying) return;
  saveMainSettings(); // 開始前強制儲存玩家設定

  const activePods = pods.filter(p => p.connected && p.active);
  if(activePods.length < 1) return alert("請至少連線並啟用 1 台裝置");

  // 初始化遊戲變數
  const code = document.getElementById('p-color').value;
  gameState.targetColorObj = COLORS.find(c => c.code === code);
  gameState.totalRounds = parseInt(document.getElementById('p-rounds').value);
  gameState.currentRound = 0;
  gameState.score = 0;
  gameState.bestTime = 9999;
  gameState.isLocked = false;

  // UI 更新
  document.getElementById('disp-score').innerText = "0";
  document.getElementById('disp-time').innerText = "-";
  const badge = document.getElementById('target-badge');
  badge.innerText = gameState.targetColorObj.name;
  badge.style.backgroundColor = gameState.targetColorObj.hex;
  badge.style.color = (gameState.targetColorObj.code === 'white' || gameState.targetColorObj.code === 'yellow' || gameState.targetColorObj.code === 'cyan') ? '#000' : '#fff';
  
  gameState.isPlaying = true;
  document.getElementById('btn-start-game').disabled = true;
  
  log(`遊戲開始：目標 ${gameState.targetColorObj.name}`);
  setTimeout(nextRound, 1000);
}

function nextRound() {
  if(!gameState.isPlaying) return;
  if(gameState.currentRound >= gameState.totalRounds) return gameOver();

  gameState.currentRound++;
  gameState.isLocked = false;

  // 邏輯同前：隨機選目標，其餘干擾
  const activeIndices = pods.map((p,i) => (p.connected && p.active) ? i : -1).filter(i => i !== -1);
  const targetIdx = activeIndices[Math.floor(Math.random() * activeIndices.length)];
  gameState.targetPodIndex = targetIdx;

  activeIndices.forEach(idx => {
      if (idx === targetIdx) {
          setPodVisual(idx, gameState.targetColorObj.r, gameState.targetColorObj.g, gameState.targetColorObj.b);
      } else {
          // 隨機干擾色
          let distractor;
          do { distractor = COLORS[Math.floor(Math.random() * COLORS.length)]; } 
          while (distractor.code === gameState.targetColorObj.code);
          setPodVisual(idx, distractor.r, distractor.g, distractor.b);
      }
  });

  gameState.startTime = performance.now();
}

function handleHit(isSuccess, idx) {
  if(!isSuccess) return;
  gameState.isLocked = true;
  
  const reactionTime = (performance.now() - gameState.startTime) / 1000;
  gameState.score++;
  
  // 更新 UI
  document.getElementById('disp-score').innerText = gameState.score;
  document.getElementById('disp-time').innerText = reactionTime.toFixed(3);

  // 全滅燈
  pods.forEach(p => setPodVisual(p.id, 0, 0, 0));

  // 上傳
  uploadData(gameState.currentRound, reactionTime, gameState.targetColorObj.name, pods[idx].deviceId);

  log(`R${gameState.currentRound} 完成: ${reactionTime.toFixed(3)}s`);
  setTimeout(nextRound, 1000); // 1秒後下一局
}

function gameOver() {
  gameState.isPlaying = false;
  document.getElementById('btn-start-game').disabled = false;
  document.getElementById('target-badge').innerText = "結束";
  document.getElementById('target-badge').style.background = "#333";
  document.getElementById('target-badge').style.color = "#fff";
  
  alert(`訓練結束！\n總分: ${gameState.score}`);
}

function stopGame() {
  gameState.isPlaying = false;
  pods.forEach(p => setPodVisual(p.id, 0, 0, 0));
  document.getElementById('btn-start-game').disabled = false;
  document.getElementById('target-badge').innerText = "已停止";
  log("手動停止遊戲");
}

function uploadData(round, time, color, devId) {
  const url = document.getElementById('gas-url').value;
  const name = document.getElementById('p-name').value;
  if(!url || url.length < 5) return;
  
  fetch(url, {
    method: 'POST', mode: 'no-cors',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({
      playerName: name, round, time, color, deviceId: devId, date: new Date().toLocaleString()
    })
  }).catch(e => console.log(e));
}

function log(msg) {
  const box = document.getElementById('console');
  box.innerHTML += `<div>> ${msg}</div>`;
  box.scrollTop = box.scrollHeight;
}
</script>
</body>
</html>